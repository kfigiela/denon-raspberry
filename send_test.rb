#!/usr/bin/env ruby
# encoding: ASCII-8BIT
require 'serialport'

sp = SerialPort.open("/dev/ttyUSB0", 115200, 8, 2, SerialPort::NONE)

#sp.write("\x00\xff\x55\x05\x00\x00\x80\x00MUON\r".force_encoding("ASCII-8BIT"))

def display_buffer(str)
  bytes = str.unpack("C*")
  puts ("%-40s" % bytes.map{|b|"%02x " % [b]}.join) + bytes.map{|b| b.chr}.join.scan(/[[:print:]]/).join.inspect
end

# packet = [0x00, 0xff, 0x55, 0x01, 0x01, 0x00, 0x10, 0x00, 0x00]
packet = [0x00, 0xff, 0x55, 0x01, 0x01, 0x00, 0x40, 0x00, 0x01]
# packet = [0x00, 0xff, 0x55, 0x01, 0x01, 0x00, 0x41, 0x00, 0x01]
# packet = [0x00, 0xff, 0x55, 0x01, 0x01, 0x00, 0x10, 0x00, 0x00]
# packet = [0x00, 0xff, 0x55, 0x06, 0x01, 0x00, 0x7f, 0x00, 0x54, 0x46, 0x41, 0x4e, 0x3f, 0x0d]
checksum = packet.reduce(&:+) & 0xff
packet << checksum
data = packet.pack("c*")
display_buffer(data)
sp.write(data)
